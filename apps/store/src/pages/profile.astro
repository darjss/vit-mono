---
// export const prerender = false;
import { auth } from "../lib/session";
import { actions } from "astro:actions";

// Set test cookie
Astro.cookies.set("testcookie", "testvalue");

// Debug cookies
console.log("ðŸ”´ Specific cookies:");
console.log("  testcookie:", Astro.cookies.get("testcookie")?.value);
console.log("  store_session:", Astro.cookies.get("store_session")?.value);

// Check if cookies exist
console.log("ðŸ”´ Cookie existence checks:");
console.log("  has testcookie:", Astro.cookies.has("testcookie"));
console.log("  has store_session:", Astro.cookies.has("store_session"));

// Check request headers for cookies (what browser sent)
console.log("ðŸ”´ Request cookies header:", Astro.request.headers.get("cookie"));

const session = await auth(Astro.cookies);

console.log("ðŸ”´ Session result:", session);
if (!session) {
  console.log("No session found");
  return Astro.redirect("/auth/login");
}
---
<div>
    <form id="logout-form" action={actions.auth.logOut}>
        <button type="submit">Logout</button>
    </form>
  <div>Profile page {session.user.phone}</div>
</div>

<script>
  import { actions } from "astro:actions";
  import { navigate } from "astro:transitions/client";

  const form = document.getElementById("logout-form") as HTMLFormElement;
  
  if (form) {
    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      
      try {
        const { error } = await actions.auth.logOut();
        
        if (!error) {
          // Logout successful, redirect to login page
          navigate("/auth/login");
        } else {
          console.error("Logout failed:", error);
        }
      } catch (error) {
        console.error("Logout error:", error);
      }
    });
  }
</script>